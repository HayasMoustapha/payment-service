const express = require('express');
const Joi = require('joi');
const router = express.Router();
const walletsController = require('../controllers/wallets.controller');
const { SecurityMiddleware, ValidationMiddleware, ContextInjector } = require('../../../../../event-planner-saas/event-planner-backend/shared');
const paymentErrorHandler = require('../../error/payment.errorHandler');

/**
 * Routes pour la gestion des wallets et commissions
 */

// Apply authentication to all routes
router.use(SecurityMiddleware.authenticated());

// Apply context injection for all authenticated routes
router.use(ContextInjector.injectUserContext());

// Apply error handler for all routes
router.use(paymentErrorHandler);

// Wallet Management
router.get('/balance', 
  requirePermission('wallets.read'),
  walletsController.getWalletBalance
);

router.get('/transactions', 
  requirePermission('wallets.read'),
  walletsController.getWalletTransactions
);

router.get('/statistics', 
  requirePermission('wallets.read'),
  walletsController.getWalletStatistics
);

// Withdrawals
router.post('/withdrawals', 
  requirePermission('wallets.withdraw'),
  validate({
    amount: schemas.amount.required(),
    withdrawalMethod: schemas.string.required(),
    withdrawalDetails: schemas.object.required()
  }, 'body'),
  walletsController.createWithdrawal
);

router.get('/withdrawals', 
  requirePermission('wallets.read'),
  walletsController.getWithdrawals
);

// Commission Management
router.get('/commissions/statistics', 
  requirePermission('commissions.read'),
  walletsController.getCommissionStatistics
);

router.get('/commissions/user', 
  requirePermission('commissions.read'),
  walletsController.getUserCommissions
);

router.get('/commissions/rates', 
  requirePermission('commissions.read'),
  walletsController.getCommissionRates
);

router.post('/commissions/projections', 
  requirePermission('commissions.read'),
  validate({
    templateSales: schemas.number.optional(),
    ticketSales: schemas.number.optional(),
    serviceFees: schemas.number.optional(),
    withdrawals: schemas.number.optional()
  }, 'body'),
  walletsController.calculateProjectedCommissions
);

// Admin Only Routes
router.post('/transfer', 
  requirePermission('admin.wallet.transfer'),
  validate({
    fromUserId: schemas.uuid.required(),
    fromUserType: schemas.string.required(),
    toUserId: schemas.uuid.required(),
    toUserType: schemas.string.required(),
    amount: schemas.amount.required(),
    metadata: schemas.object.optional()
  }, 'body'),
  walletsController.transferBetweenWallets
);

module.exports = router;
